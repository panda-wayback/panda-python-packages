name: Publish to GitHub Packages

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Hatch
        run: pip install hatch

      - name: Build and Publish
        env:
          HATCH_INDEX_USER: ${{ github.actor }}
          HATCH_INDEX_AUTH: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 遍历所有包含 pyproject.toml 的子目录
          for dir in */; do
            if [ -f "${dir}pyproject.toml" ]; then
              echo "Processing ${dir}..."
              cd ${dir}
              
              # 构建包
              hatch build
              
              # 发布到 GitHub Packages
              # 注意：GitHub Packages 的仓库地址格式为 https://npm.pkg.github.com/OWNER
              # 但对于 Python (PyPI 协议)，它是 https://maven.pkg.github.com/OWNER/REPO (或者是特殊的 URL)
              # 实际上 GitHub Packages 的 Python 支持通常使用这个 URL:
              # https://github.com/OWNER/REPO_NAME (但这不适用于 Hatch)
              
              # 纠正：GitHub Packages 使用 https://maven.pkg.github.com/OWNER/REPO 为兼容性
              # 但最简单的是直接在 Hatch 中配置自定义 Index
              
              hatch publish -r https://maven.pkg.github.com/${{ github.repository }} -u ${{ github.actor }} -a ${{ secrets.GITHUB_TOKEN }}
              
              cd ..
            fi
          done
