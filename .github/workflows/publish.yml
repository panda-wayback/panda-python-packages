name: Publish to PyPI

on:
  push:
    tags:
      - 'v*'         # æ‰“ tag v1.0.0 ä¼šè§¦å‘å‘å¸ƒåˆ° PyPI
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘ï¼ˆå¯ä»¥é€‰æ‹©ä¸Šä¼ åˆ° TestPyPI æˆ–æ­£å¼ PyPIï¼‰
    inputs:
      repository:
        description: 'ä¸Šä¼ åˆ°å“ªä¸ªä»“åº“ (testpypi æˆ– pypi)'
        required: true
        default: 'testpypi'
        type: choice
        options:
          - testpypi
          - pypi

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      # 1ï¸âƒ£ è·å–ä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4

      # 2ï¸âƒ£ è®¾ç½® Python ç¯å¢ƒ
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # 3ï¸âƒ£ å®‰è£…æ„å»ºä¾èµ–
      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install hatch twine

      # 4ï¸âƒ£ æ„å»ºåŒ…ï¼ˆç”Ÿæˆ wheel å’Œ source distributionï¼‰
      - name: Build package
        run: |
          rm -rf dist/
          hatch build
          echo "=== æ„å»ºå®Œæˆï¼Œæ£€æŸ¥äº§ç‰© ==="
          ls -lh dist/

      # 5ï¸âƒ£ ç¡®å®šä¸Šä¼ ç›®æ ‡ä»“åº“
      - name: Determine repository
        id: repo
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            # æ‰“ tag æ—¶ä¸Šä¼ åˆ°æ­£å¼ PyPI
            echo "repository=pypi" >> $GITHUB_OUTPUT
            echo "repository_url=https://upload.pypi.org/legacy/" >> $GITHUB_OUTPUT
          else
            # æ‰‹åŠ¨è§¦å‘æ—¶ï¼Œæ ¹æ®è¾“å…¥å†³å®š
            if [[ "${{ github.event.inputs.repository }}" == "pypi" ]]; then
              echo "repository=pypi" >> $GITHUB_OUTPUT
              echo "repository_url=https://upload.pypi.org/legacy/" >> $GITHUB_OUTPUT
            else
              echo "repository=testpypi" >> $GITHUB_OUTPUT
              echo "repository_url=https://test.pypi.org/legacy/" >> $GITHUB_OUTPUT
            fi
          fi
          echo "ä¸Šä¼ ç›®æ ‡: ${{ steps.repo.outputs.repository }}"

      # 6ï¸âƒ£ ä¸Šä¼ åˆ° PyPI / TestPyPI
      - name: Publish to PyPI
        env:
          # PyPI è®¤è¯ï¼šç”¨æˆ·åå¿…é¡»æ˜¯ __token__ï¼Œå¯†ç æ˜¯ API token
          TWINE_USERNAME: __token__
          # æ ¹æ®ç›®æ ‡ä»“åº“é€‰æ‹©å¯¹åº”çš„ token
          PYPI_TOKEN: ${{ secrets.PYPI_API_TOKEN }}
          TEST_PYPI_TOKEN: ${{ secrets.TEST_PYPI_API_TOKEN }}
          REPOSITORY: ${{ steps.repo.outputs.repository }}
          REPOSITORY_URL: ${{ steps.repo.outputs.repository_url }}
        run: |
          echo "=== å¼€å§‹ä¸Šä¼ åˆ° $REPOSITORY ==="
          echo "ä¸Šä¼ åœ°å€: $REPOSITORY_URL"
          
          # æ ¹æ®ç›®æ ‡ä»“åº“é€‰æ‹©å¯¹åº”çš„ token
          if [[ "$REPOSITORY" == "pypi" ]]; then
            if [ -z "$PYPI_TOKEN" ]; then
              echo "âŒ é”™è¯¯: æœªé…ç½® PYPI_API_TOKEN secret"
              echo "è¯·åœ¨ä»“åº“ Settings â†’ Secrets and variables â†’ Actions ä¸­æ·»åŠ  PYPI_API_TOKEN"
              exit 1
            fi
            export TWINE_PASSWORD="$PYPI_TOKEN"
            echo "âœ… ä½¿ç”¨æ­£å¼ PyPI token"
          else
            if [ -z "$TEST_PYPI_TOKEN" ]; then
              echo "âŒ é”™è¯¯: æœªé…ç½® TEST_PYPI_API_TOKEN secret"
              echo "è¯·åœ¨ä»“åº“ Settings â†’ Secrets and variables â†’ Actions ä¸­æ·»åŠ  TEST_PYPI_API_TOKEN"
              exit 1
            fi
            export TWINE_PASSWORD="$TEST_PYPI_TOKEN"
            echo "âœ… ä½¿ç”¨ TestPyPI token"
          fi
          
          # ä¸Šä¼ åŒ…
          twine upload \
            --repository-url "$REPOSITORY_URL" \
            --verbose \
            dist/*
          
          echo ""
          echo "âœ… ä¸Šä¼ æˆåŠŸåˆ° $REPOSITORYï¼"
          echo ""
          if [[ "$REPOSITORY" == "pypi" ]]; then
            echo "ğŸ“¦ å®‰è£…æ–¹å¼:"
            echo "   pip install panda-python-packages"
          else
            echo "ğŸ“¦ TestPyPI å®‰è£…æ–¹å¼:"
            echo "   pip install -i https://test.pypi.org/simple/ panda-python-packages"
            echo ""
            echo "âš ï¸  æ³¨æ„: TestPyPI ä»…ç”¨äºæµ‹è¯•ï¼Œæ­£å¼å‘å¸ƒè¯·ä½¿ç”¨æ­£å¼ PyPI"
          fi
